{% extends "school/base_one.html" %}
{% load form_filters %}
{% load static %}
{% load i18n allauth account %}

{% block title %}
    {% trans "Password Reset" %}
{% endblock title %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'onetech/styles/shop_styles.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'onetech/styles/shop_responsive.css' %}">

<section class="blog-banner-area" id="category">
    <div class="container h-100">
        <div class="blog-banner">
            <div class="text-center">
                <h1>Сброс пароля</h1>
                <nav aria-label="breadcrumb" class="banner-breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}">Домой</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Сброс пароля</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</section>

<section class="login_box_area section-margin">
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class="login_form_inner register_form_inner">
                    <form id="passwordResetForm" class="row login_form" method="post" novalidate>
                        {% csrf_token %}
                        {{ redirect_field }}
                        
						{% include "includes/form_fields.html" with form=form %}

                        <div class="col-md-12 form-group">
                            <button type="submit" class="btn btn-primary">Сменить пароль</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const password1 = document.getElementById("id_password1");
    const password2 = document.getElementById("id_password2");

    const showError = (input, message) => {
        input.classList.add("is-invalid");
        let feedback = input.parentNode.querySelector(".invalid-feedback");
        if (!feedback) {
            feedback = document.createElement("div");
            feedback.className = "invalid-feedback d-block";
            input.parentNode.appendChild(feedback);
        }
        feedback.textContent = message;
        feedback.style.display = 'block';
    };

    const clearError = (input) => {
        input.classList.remove("is-invalid");
        const feedback = input.parentNode.querySelector(".invalid-feedback");
        if (feedback) {
            feedback.textContent = "";
            feedback.style.display = 'none';
        }
    };

    const isPasswordComplex = (password) => {
        const lengthCheck = password.length >= 8;
        const upperCheck = /[A-ZА-Я]/.test(password);
        const lowerCheck = /[a-zа-я]/.test(password);
        const digitCheck = /\d/.test(password);
        const specialCheck = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

        return lengthCheck && upperCheck && lowerCheck && digitCheck && specialCheck;
    };

    const validatePasswords = () => {
        let valid = true;
        const pwd = password1?.value;
        const pwd2 = password2?.value;

        if (password1 && !isPasswordComplex(pwd)) {
            showError(password1, "Пароль должен содержать минимум:\n• 8 символов\n• заглавную и строчную буквы\n• цифру\n• спецсимвол");
            valid = false;
        } else if (password1) {
            clearError(password1);
        }

        if (password1 && password2 && pwd !== pwd2) {
            showError(password2, "Пароли не совпадают.");
            valid = false;
        } else if (password2) {
            clearError(password2);
        }

        return valid;
    };

    // Валидация при отправке формы
    const form = document.querySelector("form");
    form?.addEventListener("submit", function (e) {
        if (!validatePasswords()) {
            e.preventDefault();
        }
    });

    // Подсказки (help-text) при фокусе
    document.querySelectorAll(".form-control").forEach(input => {
        const helpText = input.closest(".form-group")?.querySelector(".help-text");
        if (helpText) {
            input.addEventListener("focus", () => helpText.style.display = "block");
            input.addEventListener("blur", () => {
                if (!input.value || input.validity.valid) {
                    helpText.style.display = "none";
                }
            });
        }
    });

    password1?.addEventListener("input", validatePasswords);
    password2?.addEventListener("input", validatePasswords);
});
</script>
{% endblock %}
